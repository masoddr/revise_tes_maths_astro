---
// Contact form with enhanced fields as per devbook specifications
// Uses Web3Forms (free, unlimited submissions)
// Access key can be set via environment variable: PUBLIC_WEB3FORMS_ACCESS_KEY
// Or use the default key below
const accessKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY || '6afff405-0be2-4bd7-8388-d94686c2329b';
---

<form 
  id="contact-form"
  class="bg-white border border-gray-200 rounded-lg p-5 md:p-6 space-y-4"
  method="POST"
  action="https://api.web3forms.com/submit"
>
  <!-- Hidden field for Web3Forms access key (required) -->
  <input type="hidden" name="access_key" value={accessKey} />
  <!-- Honeypot field for spam protection -->
  <input type="checkbox" name="botcheck" style="display: none;" tabindex="-1" autocomplete="off" />
  
  <!-- Web3Forms fields are handled in JavaScript -->
  <div>
    <label for="nom" class="block text-gray-700 font-medium mb-2 text-sm">
      Nom complet
    </label>
    <input
      type="text"
      id="nom"
      name="nom"
      required
      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent text-sm text-gray-900 placeholder-gray-400"
      placeholder="Votre nom complet"
    />
  </div>

  <div>
    <label for="telephone" class="block text-gray-700 font-medium mb-2 text-sm">
      Téléphone
    </label>
    <input
      type="tel"
      id="telephone"
      name="telephone"
      required
      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent text-sm text-gray-900 placeholder-gray-400"
      placeholder="06 12 34 56 78"
    />
  </div>

  


  <div>
    <label for="message" class="block text-gray-700 font-medium mb-2 text-sm">
      Message
    </label>
    <textarea
      id="message"
      name="message"
      rows="3"
      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent text-sm resize-y text-gray-900 placeholder-gray-400"
      placeholder="Votre message (optionnel)"
    ></textarea>
  </div>

  <div id="form-message" class="hidden p-4 rounded-lg border transition-all duration-300">
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0">
        <svg id="form-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <div class="flex-1">
        <p id="form-message-text" class="text-sm font-medium"></p>
      </div>
    </div>
  </div>

  <button
    type="submit"
    class="w-full bg-gray-900 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800 transition-colors text-sm"
  >
  Demander un premier échange
  </button>
</form>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }
</style>

<script>
  const form = document.getElementById('contact-form');
  const messageDiv = document.getElementById('form-message');
  const messageText = document.getElementById('form-message-text');
  const formIcon = document.getElementById('form-icon');
  const submitButton = form?.querySelector('button[type="submit"]');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const messageDiv = document.getElementById('form-message');
    const messageText = document.getElementById('form-message-text');
    const formIcon = document.getElementById('form-icon');
    const submitButton = form?.querySelector('button[type="submit"]');
    
    if (!messageDiv || !messageText || !formIcon || !form) return;
    
    const originalText = submitButton?.textContent || 'Demander un premier échange';
    
    // Show loading state
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'Envoi en cours...';
    }
    
    // Get form data and prepare for Web3Forms
    // Use FormData from the form element to include all fields including hidden access_key
    const formData = new FormData(form);
    
    // Add/override fields for Web3Forms format
    const nomInput = form.querySelector('[name="nom"]');
    const emailInput = form.querySelector('[name="email"]');
    const telephoneInput = form.querySelector('[name="telephone"]');
    const classeInput = form.querySelector('[name="classe"]');
    const messageInput = form.querySelector('[name="message"]');
    
    const nom = nomInput?.value || '';
    const email = emailInput?.value || '';
    const telephone = telephoneInput?.value || '';
    const classe = classeInput?.value || '';
    const message = messageInput?.value || '';
    
    // Map to Web3Forms format (they accept any field names, but we'll use standard ones)
    formData.set('name', nom);
    if (email) formData.set('email', email);
    formData.set('telephone', telephone);
    if (classe) formData.set('classe', classe);
    formData.set('message', message);
    formData.set('subject', 'Nouveau contact depuis Revise Tes Maths');
    formData.set('from_name', 'Revise Tes Maths');
    
    // Verify access_key is present
    if (!formData.get('access_key')) {
      console.error('Web3Forms access key is missing. Please set PUBLIC_WEB3FORMS_ACCESS_KEY environment variable.');
      throw new Error('Configuration error: access key missing');
    }
    
    try {
      // Submit to Web3Forms
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (response.ok && result.success) {
        // Show success message
        messageDiv.classList.remove('hidden');
        messageDiv.className = 'p-4 rounded-lg bg-green-50 border border-green-200 animate-fade-in';
        
        // Success icon
        formIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />';
        formIcon.classList.add('text-green-600');
        formIcon.classList.remove('text-red-600');
        
        messageText.textContent = "Merci pour votre message ! Je reviens vers vous sous 24h pour proposer un créneau d'échange.";
        messageText.className = 'text-sm font-medium text-green-800';
        
        form?.reset();
        
        // Scroll to message
        messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Hide message after 10 seconds
        setTimeout(() => {
          messageDiv.classList.add('hidden');
        }, 10000);
      } else {
        // Get error message from API response
        const errorMsg = result.message || `Erreur ${response.status}: ${response.statusText}`;
        throw new Error(errorMsg);
      }
    } catch (error) {
      // Show error message with details
      messageDiv.classList.remove('hidden');
      messageDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200 animate-fade-in';
      
      // Error icon
      formIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />';
      formIcon.classList.add('text-red-600');
      formIcon.classList.remove('text-green-600');
      
      // Show specific error message if available
      const errorMessage = error instanceof Error 
        ? `Erreur: ${error.message}` 
        : "Une erreur est survenue. Veuillez réessayer ou me contacter directement par WhatsApp.";
      
      messageText.textContent = errorMessage;
      messageText.className = 'text-sm font-medium text-red-800';
      
      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } finally {
      // Reset button
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    }
  });
</script>
