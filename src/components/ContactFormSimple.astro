---
// Formulaire simplifié pour landing page Google Ads
// Prénom + Téléphone uniquement
const accessKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY || '6afff405-0be2-4bd7-8388-d94686c2329b';
---

<form 
  id="contact-form-simple"
  class="bg-white border border-gray-200 rounded-lg p-5 md:p-6 space-y-4"
  method="POST"
  action="https://api.web3forms.com/submit"
>
  <!-- Hidden field for Web3Forms access key -->
  <input type="hidden" name="access_key" value={accessKey} />
  <!-- Honeypot field for spam protection -->
  <input type="checkbox" name="botcheck" style="display: none;" tabindex="-1" autocomplete="off" />
  
  <div>
    <label for="prenom" class="block text-gray-700 font-medium mb-2 text-sm">
      Prénom
    </label>
    <input
      type="text"
      id="prenom"
      name="prenom"
      required
      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent text-sm text-gray-900 placeholder-gray-400"
      placeholder="Votre prénom"
    />
  </div>

  <div>
    <label for="telephone-simple" class="block text-gray-700 font-medium mb-2 text-sm">
      Téléphone
    </label>
    <input
      type="tel"
      id="telephone-simple"
      name="telephone"
      required
      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent text-sm text-gray-900 placeholder-gray-400"
      placeholder="06 12 34 56 78"
    />
  </div>

  <div id="form-message-simple" class="hidden p-4 rounded-lg border transition-all duration-300">
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0">
        <svg id="form-icon-simple" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <div class="flex-1">
        <p id="form-message-text-simple" class="text-sm font-medium"></p>
      </div>
    </div>
  </div>

  <button
    type="submit"
    id="submit-button-simple"
    class="w-full bg-gray-900 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-800 transition-all duration-300 text-sm shadow-lg hover:shadow-xl transform hover:scale-105"
  >
    Être rappelé gratuitement
  </button>
  
  <p class="text-xs text-gray-500 text-center mt-2">
    Réponse sous 24h • Sans engagement
  </p>
</form>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }
</style>

<script>
  const form = document.getElementById('contact-form-simple');
  const messageDiv = document.getElementById('form-message-simple');
  const messageText = document.getElementById('form-message-text-simple');
  const formIcon = document.getElementById('form-icon-simple');
  const submitButton = form?.querySelector('button[type="submit"]');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!messageDiv || !messageText || !formIcon || !form) return;
    
    const formElement = form as HTMLFormElement;
    const originalText = submitButton?.textContent || 'Être rappelé gratuitement';
    
    // Show loading state
    if (submitButton) {
      (submitButton as HTMLButtonElement).disabled = true;
      submitButton.textContent = 'Envoi en cours...';
    }
    
    // Get form data
    const formData = new FormData(formElement);
    const prenomInput = form.querySelector('[name="prenom"]') as HTMLInputElement;
    const telephoneInput = form.querySelector('[name="telephone"]') as HTMLInputElement;
    
    const prenom = prenomInput?.value || '';
    const telephone = telephoneInput?.value || '';
    
    // Map to Web3Forms format
    formData.set('name', prenom);
    formData.set('telephone', telephone);
    formData.set('subject', 'Demande de rappel - Landing Google Ads');
    formData.set('from_name', 'Revise Tes Maths');
    
    // Verify access_key is present
    if (!formData.get('access_key')) {
      console.error('Web3Forms access key is missing.');
      throw new Error('Configuration error: access key missing');
    }
    
    try {
      // Submit to Web3Forms
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (response.ok && result.success) {
        // Track conversion for Google Ads
        const gtag = (window as any).gtag;
        if (typeof gtag === 'function') {
          gtag('event', 'conversion', {
            'send_to': 'AW-CONVERSION_ID/CONVERSION_LABEL',
            'value': 1.0,
            'currency': 'EUR'
          });
        }
        
        // Track with Vercel Analytics if available
        import('@vercel/analytics').then((analytics) => {
          if (analytics && typeof analytics.track === 'function') {
            analytics.track('Contact Form Submit', { 
              status: 'success',
              page: 'google-ads-landing',
              source: 'google-ads'
            });
          }
        }).catch(() => {
          // Vercel Analytics not available, ignore
        });
        
        // Show success message
        messageDiv.classList.remove('hidden');
        messageDiv.className = 'p-4 rounded-lg bg-green-50 border border-green-200 animate-fade-in';
        
        // Success icon
        formIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />';
        formIcon.classList.add('text-green-600');
        formIcon.classList.remove('text-red-600');
        
        messageText.textContent = "Merci ! Je vous rappelle sous 24h pour un premier échange gratuit.";
        messageText.className = 'text-sm font-medium text-green-800';
        
        formElement.reset();
        
        // Scroll to message
        messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Hide message after 10 seconds
        setTimeout(() => {
          messageDiv.classList.add('hidden');
        }, 10000);
      } else {
        // Get error message from API response
        const errorMsg = result.message || `Erreur ${response.status}: ${response.statusText}`;
        throw new Error(errorMsg);
      }
    } catch (error) {
      // Show error message
      messageDiv.classList.remove('hidden');
      messageDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200 animate-fade-in';
      
      // Error icon
      formIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />';
      formIcon.classList.add('text-red-600');
      formIcon.classList.remove('text-green-600');
      
      const errorMessage = error instanceof Error 
        ? `Erreur: ${error.message}` 
        : "Une erreur est survenue. Veuillez réessayer.";
      
      messageText.textContent = errorMessage;
      messageText.className = 'text-sm font-medium text-red-800';
      
      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } finally {
      // Reset button
      if (submitButton) {
        (submitButton as HTMLButtonElement).disabled = false;
        submitButton.textContent = originalText;
      }
    }
  });
</script>
